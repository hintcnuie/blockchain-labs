# Blockchain Lab 2 - Deploy and invoke chaincode

We will download and install a simple chaincode into our Blockchain network.  The example chaincode allows us to do three things:
-	set up two participants, A and B, and provide each with an initial value
-	transfer an amount of value from one participant to the other
-	query the value for each participant

You can examine the chaincode here: https://github.com/hyperledger/fabric/blob/master/examples/chaincode/go/chaincode_example02/chaincode_example02.go

## Deploy the chaincode
To deploy the chaincode we are going to attach to a running container, and execute some commands inside it (this is similar to ‘SSH’ing into a virtual machine).

Start a second Terminal window, and run the following command (it doesn’t matter which directory you’re in).  

Check the `docker ps` output and note the container name of the _vp0_ peer - it will be something like _lab1_vp0_1_, based on your directory name. This is different to the container ID, which is a random 12 character string.

Now use the command `docker exec` to attach to the named container and execute the instruction _bash_ to start the command line inside the container.
```bash
$ docker exec –it <container-name> bash
```

To be clear, you now have two Terminal windows.  The first (we’ll call it T1) has the command line for your local machine, and is set to your working directory.   The second (T2) has the command line for your _vp0_ container.

<img src="./images/lab2-img1.png" alt="Lab 2 Terminal windows" style="width: 400px;"/>

In Terminal T2, run the following commands to log in as WebAppAdmin, and to deploy the chaincode you looked at before (the second command should be entered all on one line).
```bash
$ peer network login WebAppAdmin -p DJY27pEnl16d
$ peer chaincode deploy \
  –u WebAppAdmin \
  –p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 \
  –c '{"Function":"init", "Args": ["a", "100", "b", "200"]}'
```
> **NB:** the password used here is hard-coded into the Hyperledger Docker container.

When chaincode is deployed it is also initialized.  Note that we are passing 4 arguments to the init() function.  The result of this is to set the value of ‘a’ to 100 and ‘b’ to 200.  You can check this by looking at the chaincode, as above.

In the response you should see `Deploy chaincode` followed by a 128-character chaincode name, automatically generated by Hyperledger.  Copy and paste this somewhere, you will use it in a moment.

Switch back to Terminal T1 and use the API (`curl localhost:7050/chain`) to check that a new block has been added.  The deployment of the chaincode will create a new block; this is because in a real network you would want the relevant participants to agree that the chaincode is correct, and has been approved for deployment.

You can also look at each individual block:
```bash
$ curl localhost:7050/chain/blocks/1
```

## Query the chaincode
Back in Terminal T2, execute the following command to query the chaincode you just deployed.  Replace `<chaincode-name>` with the 128-character name you copied earlier.
```bash
$ peer chaincode query –u WebAppAdmin –n <chaincode-name> –c '{"Function":"query", "Args": ["a"]}'
```
The value of ‘a’ should be 100, which is the value we initialised it to when we deployed the chaincode.

## Invoke a transaction
Now we’re going to invoke a transaction to transfer 10 from ‘a’ to ‘b’:
```bash
$ peer chaincode invoke –u WebAppAdmin –n <chaincode-name> –c '{"Function":"invoke", "Args": ["a", "b", "10"]}'
```
If you switch back to Terminal T1 and run `curl localhost:7050/chain` you will see that a third block has been added.  Every transaction will be added to the chain, which will result in a new block.

Now go back to Terminal T2 and run the `peer chaincode query ...` command again.  You should see that the value of ‘a’ is now 90.

Type exit to leave the container’s command line.  You can now close this window.

## Cleaning up
Congratulations! You’ve just deployed and invoked chaincode on a Hyperledger Blockchain network.

The easiest way to clean up your containers is like this:
```bash
$ docker-compose down
```
which does the opposite of `docker-compose up`.  However it is useful to know the other Docker commands for cleaning up:
-	`docker kill` – sends SIGTERM to the running process in a container, stopping it
-	`docker stop` – stops the container itself
-	`docker rm` – removes the container completely

> **Learning Point**: don't get confused with containers and images. An image is a template for creating a container. A container is an actual process which can run (although it may be stopped). You can create multiple containers from the same image.

You can pass the individual container IDs to these commands (or the first 3 characters, which will also work), for example
```bash
$ docker stop 2a5 3d1
```
Or you can use the following compound instructions, which will stop & remove all containers
```bash
$ docker stop $(docker ps –qa)
$ docker rm $(docker ps –qa)
```

Hyperledger also creates a new container image for the chaincode you deployed, and although you have removed that container you should also remove the image it was created from, as it may cause problems with future labs.  Get the image ID from docker images, then
```bash
$ docker rmi <image-id>
```

Continue with [lab 3](./lab3.md).
